<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æŠ±æŠ±ç†Š | å¾Œå°ç®¡ç†ç³»çµ±</title>
    
    <!-- Favicon -->
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest-admin.json">
    
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- å¥—ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = { 
            theme: {
                extend: {
                    colors: {
                        theme: {
                            bg: '#FFFBF0',
                            brown: '#5D4037',
                            brownLight: '#8D6E63',
                            orange: '#D98E4F',
                            orangeSoft: '#F2D0B4',
                            text: '#3E2723',
                            sub: '#795548',
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        rounded: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(93, 64, 55, 0.05)',
                        'card': '0 4px 12px -2px rgba(93, 64, 55, 0.1)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: { from: { opacity: '0', transform: 'translateY(20px)' }, to: { opacity: '1', transform: 'translateY(0)' } },
                        fadeIn: { from: { opacity: '0' }, to: { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #FFFBF0;
            background-image: radial-gradient(#8D6E63 0.5px, transparent 0.5px);
            background-size: 24px 24px;
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            color: #3E2723;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(8px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: var(--tw-shadow-glass);
            border-radius: 20px;
        }

        .input-minimal {
            width: 100%;
            background: #FFFFFF;
            border: 1px solid #E0E0E0;
            padding: 0.8rem 1rem;
            font-size: 16px;
            border-radius: 12px;
            transition: all 0.3s;
-webkit-appearance: none;
appearance: none;
        }
        .input-minimal:focus {
            border-color: #D98E4F;
            box-shadow: 0 0 0 3px rgba(217, 142, 79, 0.1);
            outline: none;
        }

        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Toast æ¨£å¼ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 90vw;
            animation: slide-in-right 0.3s ease-out forwards;
            border-left: 4px solid;
        }
        .toast.success { border-color: #10B981; }
        .toast.error { border-color: #EF4444; }
        .toast.info { border-color: #3B82F6; }
        .toast-message { flex: 1; font-size: 0.875rem; color: #374151; }
        .toast-close { margin-left: 12px; color: #9CA3AF; cursor: pointer; }
        
        @keyframes slide-in-right {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>

<body class="min-h-screen relative flex flex-col max-w-lg mx-auto shadow-2xl bg-[#FFFBF0]">

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-view" class="min-h-screen flex items-center justify-center p-6 animate-slide-up">
        <div class="glass-panel p-8 w-full max-w-sm text-center space-y-6">
            <div class="mx-auto w-24 h-24 rounded-full bg-white p-1 shadow-lg border border-theme-brown/10 -mt-16 mb-4 flex items-center justify-center">
                <img src="logo.png" alt="Logo" class="w-full h-full object-cover rounded-full">
            </div>

            <div>
                <h1 class="text-2xl font-bold text-theme-brown tracking-wider">æŠ±æŠ±ç†Šå¾Œå°</h1>
                <p class="text-xs text-theme-sub mt-1">Admin Dashboard</p>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <i data-lucide="lock" class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="password" id="admin-password" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" 
                           class="input-minimal pl-12 text-center tracking-widest"
                           onkeydown="if(event.key==='Enter') handleLogin()">
                </div>
                
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-theme-brown text-white py-4 rounded-xl font-bold shadow-lg shadow-theme-brown/20 active:scale-95 transition-all flex items-center justify-center gap-2">
                    ç™»å…¥ç³»çµ± <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="pt-4 border-t border-theme-brown/10">
                <a href="index.html" class="text-xs text-theme-sub hover:text-theme-orange transition-colors inline-flex items-center gap-1">
                    <i data-lucide="arrow-left" class="w-3 h-3"></i> è¿”å›é¦–é 
                </a>
            </div>
        </div>
    </div>

    <!-- ä¸»æ§å°ç•«é¢ -->
    <div id="dashboard-view" class="hidden min-h-screen pb-24">
<!-- é ‚éƒ¨å°èˆªåˆ— -->
<nav class="bg-[#FFFBF0]/95 backdrop-blur-sm border-b border-theme-brown/10 sticky top-0 z-40">
    <div class="px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full bg-theme-brown/10 flex items-center justify-center text-theme-brown border border-theme-brown/20">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            </div>
            <span class="font-bold text-lg text-theme-brown tracking-wider">å¾Œå°ç®¡ç†</span>
        </div>
        <!-- é€™è£¡æ˜¯æ–°å¢çš„éƒ¨åˆ†ï¼šè®Šæ›´å¯†ç¢¼èˆ‡ç™»å‡ºæŒ‰éˆ• -->
        <div class="flex items-center gap-2">
            <button onclick="openChangePasswordModal()" class="text-xs font-bold text-theme-text hover:text-theme-orange px-3 py-2 rounded-lg hover:bg-theme-orange/5 transition flex items-center gap-1.5" title="è®Šæ›´å¯†ç¢¼">
                <i data-lucide="key-round" class="w-4 h-4"></i> <span class="hidden sm:inline">è®Šæ›´å¯†ç¢¼</span>
            </button>
            <div class="w-px h-4 bg-gray-300 mx-1"></div>
            <button onclick="handleLogout()" class="text-xs font-bold text-theme-sub hover:text-theme-orange px-3 py-2 rounded-lg hover:bg-theme-orange/5 transition flex items-center gap-1.5">
                <i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡º
            </button>
        </div>
    </div>
</nav>

        <div class="p-5 space-y-5">
            <!-- æ¨™é¡Œèˆ‡æœå°‹ -->
            <div class="flex flex-col gap-4">
                <div>
                    <h2 class="text-xl font-bold text-theme-brown tracking-wider">ç¾å®¹å¥‘ç´„åˆ—è¡¨</h2>
                    <p class="text-xs text-theme-sub mt-1">Service Contracts</p>
                </div>
                <div class="relative group">
                    <i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50 group-focus-within:text-theme-orange transition-colors"></i>
                    <input type="search" id="search-input" placeholder="æœå°‹å¯µç‰©åã€ä¸»äººå§“åã€é›»è©±..." 
                           class="input-minimal pl-10 py-2.5 text-sm bg-white/80">
                </div>
            </div>

            <!-- åˆ—è¡¨å®¹å™¨ -->
            <div id="content-area" class="space-y-3">
                <div class="text-center py-10 text-theme-sub/50">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è©³æƒ…/ç·¨è¼¯å½ˆçª— -->
    <div id="detail-modal" class="fixed inset-0 bg-theme-text/20 hidden z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-[#FFFBF0] w-full max-w-3xl rounded-t-[32px] sm:rounded-[32px] flex flex-col shadow-2xl transform transition-transform duration-300 max-h-[90vh] border border-white/50" id="modal-panel">
            
            <!-- å½ˆçª—æ¨™é¡Œ -->
            <div class="p-6 border-b border-theme-brown/10 flex justify-between items-center bg-white/50 rounded-t-[32px] shrink-0">
                <div>
                    <h2 class="text-xl font-black text-theme-brown tracking-wider">åˆç´„è©³æƒ…</h2>
                    <span class="text-[10px] text-theme-sub uppercase tracking-widest font-bold" id="modal-id">ID: #0000</span>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-theme-sub hover:text-theme-orange hover:shadow-md transition">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- å½ˆçª—å…§å®¹ -->
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-6 bg-[#FFFBF0]" id="modal-content">
                <!-- JS å‹•æ…‹å¡«å…¥ -->
            </div>
            
            <!-- å½ˆçª—åº•éƒ¨æŒ‰éˆ• -->
            <div class="p-5 border-t border-theme-brown/10 bg-white/80 backdrop-blur rounded-b-none sm:rounded-b-[32px] flex justify-between items-center gap-3 shrink-0">
                <button onclick="requestDelete()" class="text-red-400 font-bold px-4 py-3 hover:bg-red-50 rounded-xl transition active:scale-95 flex items-center gap-2 text-sm">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> åˆªé™¤
                </button>
                <div class="flex gap-3 flex-1 justify-end">
                    <button onclick="enableEdit()" id="btn-edit" class="bg-white border border-theme-brown/20 text-theme-text px-6 py-3 rounded-xl font-bold hover:border-theme-orange hover:text-theme-orange transition active:scale-95 shadow-sm">
                        ç·¨è¼¯è³‡æ–™
                    </button>
                    <button onclick="saveChanges()" id="btn-save" class="hidden bg-theme-brown text-white px-6 py-3 rounded-xl font-bold hover:bg-theme-brownLight transition active:scale-95 shadow-lg flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> å„²å­˜è®Šæ›´
                    </button>
                </div>
            </div>
        </div>
    </div>
<!-- è®Šæ›´å¯†ç¢¼å½ˆçª— -->
<div id="change-pwd-modal" class="fixed inset-0 bg-theme-text/40 hidden z-[80] flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
    <div class="bg-white p-8 rounded-[24px] w-full max-w-[400px] shadow-2xl transform scale-95 transition-transform duration-300 relative">
        
        <!-- é—œé–‰æŒ‰éˆ• -->
        <button onclick="closeChangePasswordModal()" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>

        <h3 class="text-xl font-bold text-theme-brown mb-8 tracking-wider font-serif">è®Šæ›´ç®¡ç†å¯†ç¢¼</h3>

        <div class="space-y-4">
            <!-- èˆŠå¯†ç¢¼ -->
            <div class="relative group">
                <i data-lucide="lock" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                <input type="password" id="cp-old-password" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" 
                       class="w-full bg-[#FFFBF0] border border-transparent focus:bg-white focus:border-theme-orange/30 rounded-xl py-3 pl-11 pr-4 text-sm text-theme-text outline-none transition-all placeholder:text-gray-400">
            </div>

            <!-- æ–°å¯†ç¢¼ -->
            <div class="relative group">
                <i data-lucide="key" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                <input type="password" id="cp-new-password" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘6ä½)" 
                       class="w-full bg-[#FFFBF0] border border-transparent focus:bg-white focus:border-theme-orange/30 rounded-xl py-3 pl-11 pr-4 text-sm text-theme-text outline-none transition-all placeholder:text-gray-400">
            </div>

            <!-- ç¢ºèªæ–°å¯†ç¢¼ -->
            <div class="relative group">
                <i data-lucide="shield-check" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                <input type="password" id="cp-confirm-password" placeholder="ç¢ºèªæ–°å¯†ç¢¼" 
                       class="w-full bg-[#FFFBF0] border border-transparent focus:bg-white focus:border-theme-orange/30 rounded-xl py-3 pl-11 pr-4 text-sm text-theme-text outline-none transition-all placeholder:text-gray-400">
            </div>
        </div>

        <div class="flex gap-3 mt-8">
            <button onclick="closeChangePasswordModal()" class="flex-1 py-3 bg-[#F3F4F6] text-theme-text font-bold rounded-xl hover:bg-gray-200 transition text-sm">
                å–æ¶ˆ
            </button>
            <button onclick="handleChangePassword()" id="btn-change-pwd" class="flex-1 py-3 bg-theme-brown text-white font-bold rounded-xl shadow-lg hover:bg-theme-brownLight active:scale-95 transition text-sm flex items-center justify-center gap-2">
                ç¢ºèªä¿®æ”¹
            </button>
        </div>
    </div>
</div>
    <!-- é€šç”¨å¯†ç¢¼é©—è­‰å½ˆçª— -->
    <div id="auth-modal" class="fixed inset-0 bg-theme-text/40 hidden z-[70] flex items-center justify-center p-6 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-[32px] w-full max-w-xs text-center space-y-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <div class="mx-auto w-16 h-16 rounded-full bg-theme-brown/5 flex items-center justify-center text-theme-brown mb-2">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            
            <div class="space-y-2">
                <h3 class="text-xl font-black text-theme-brown" id="auth-title">å®‰å…¨é©—è­‰</h3>
                <p class="text-sm text-theme-sub font-medium" id="auth-desc">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
            </div>

            <div class="relative group text-left">
                <i data-lucide="key" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-theme-sub/50"></i>
                <input type="password" id="auth-password" placeholder="è¼¸å…¥å¯†ç¢¼" 
                       class="input-minimal pl-10 text-center tracking-widest bg-gray-50 border-gray-200"
                       onkeydown="if(event.key==='Enter') handleAuthConfirm()">
            </div>

            <div class="flex gap-3">
                <button onclick="closeAuthModal()" class="flex-1 py-3 bg-gray-100 text-theme-sub font-bold rounded-xl active:scale-95 transition">å–æ¶ˆ</button>
                <button onclick="handleAuthConfirm()" id="auth-confirm-btn" class="flex-1 py-3 bg-theme-brown text-white font-bold rounded-xl shadow-lg shadow-theme-brown/20 active:scale-95 transition">
                    ç¢ºèª
                </button>
            </div>
        </div>
    </div>

<script>
    // åˆå§‹åŒ–
    lucide.createIcons();

    // --- Supabase è¨­å®š ---
    // âš ï¸ è«‹æ›¿æ›ç‚ºä½ çš„ Supabase URL å’Œ Anon Key
    const SUPABASE_URL = 'https://slkfbsvxoriqmwoeobop.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_DQs8LxhRWCms6OcCspB8Jw_Xnm97iBk';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // å…¨åŸŸè®Šæ•¸
    let fullDataList = [];
    let currentItem = null;
    let pendingAction = null; // å„²å­˜å¾…åŸ·è¡Œçš„å‹•ä½œ ('save' æˆ– 'delete')

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    async function checkSession() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (session) { 
            showDashboard();
        }
    }
    checkSession();

    // é¡¯ç¤ºä¸»æ§å°
    function showDashboard() {
        document.getElementById('login-view').classList.add('hidden'); 
        document.getElementById('dashboard-view').classList.remove('hidden'); 
        loadData(); 
    }

    // ç™»å…¥è™•ç†
    async function handleLogin() {
        const btn = document.getElementById('login-btn');
        const originalBtnHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i>';
        lucide.createIcons();

        const password = document.getElementById('admin-password').value;
        
        const email = 'hugbear0903@gmail.com'; 
        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
            return;
        }

        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
            document.getElementById('admin-password').value = '';
            btn.disabled = false;
            btn.innerHTML = originalBtnHTML;
        } else {
            showToast('ç™»å…¥æˆåŠŸï¼', 'success');
            showDashboard();
        }
    }

    // ç™»å‡º
    async function handleLogout() {
        await _supabase.auth.signOut();
        location.reload();
    }

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
        const container = document.getElementById('content-area');
        
        // éª¨æ¶å±
        container.innerHTML = Array(5).fill(0).map(() => `
            <div class="glass-panel p-4 rounded-2xl flex justify-between items-center skeleton-card">
                <div class="space-y-2 w-1/2">
                    <div class="h-4 bg-gray-200 rounded w-1/3"></div>
                    <div class="h-6 bg-gray-200 rounded w-2/3"></div>
                </div>
                <div class="h-8 w-20 bg-gray-200 rounded-lg"></div>
            </div>
        `).join('');

        const { data, error } = await _supabase
            .from('contracts') // âš ï¸ é€™è£¡å°æ‡‰æˆ‘å€‘ä¹‹å‰å»ºç«‹çš„è³‡æ–™è¡¨åç¨±
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<div class="text-center text-red-400 py-10">è®€å–éŒ¯èª¤: ${error.message}</div>`;
            return;
        }

        fullDataList = data;
        renderDataList(data);
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderDataList(data) {
        const container = document.getElementById('content-area');
        
        if (!data || data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-20 h-20 bg-theme-sub/5 rounded-full flex items-center justify-center mx-auto mb-4">
                         <i data-lucide="file-x" class="w-10 h-10 text-theme-sub/30"></i>
                    </div>
                    <p class="text-theme-sub font-bold">æš«ç„¡è³‡æ–™</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        container.innerHTML = data.map((item, index) => {
            const date = new Date(item.created_at).toLocaleString('zh-TW', {
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });

            // åˆ¤æ–·æ˜¯å¦æœ‰é¢¨éšªæ¨™ç±¤
            const hasRisk = item.aggressive === 'æ˜¯' || item.friendly_to_dogs === 'å¦';
            const riskTag = hasRisk ? 
                `<span class="px-2 py-0.5 rounded-md bg-red-100 text-red-500 text-[10px] font-bold whitespace-nowrap">éœ€æ³¨æ„</span>` : '';

            // åˆ¤æ–·æ˜¯å¦æœ‰å‚™è¨»
            const hasNotes = item.admin_notes && item.admin_notes.trim().length > 0;
            const noteTag = hasNotes ? 
                `<span class="px-2 py-0.5 rounded-md bg-theme-orange/10 text-theme-orange text-[10px] font-bold flex items-center gap-1 whitespace-nowrap"><i data-lucide="sticky-note" class="w-3 h-3"></i> å‚™è¨»</span>` : '';

            // åªæœ‰åœ¨æœ‰é¢¨éšªæˆ–å‚™è¨»æ™‚ï¼Œæ‰é¡¯ç¤ºé€™ä¸€æ•´è¡Œ div
            const tagsHtml = (riskTag || noteTag) ? 
                `<div class="flex items-center gap-2 flex-wrap mt-1">${riskTag}${noteTag}</div>` : '';

            return `
            <div onclick="openModal('${item.id}')" class="glass-panel p-5 rounded-2xl flex justify-between items-center cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all group border-l-4 border-l-transparent hover:border-l-theme-orange">
                <div class="flex items-center gap-4 w-full overflow-hidden">
                    <div class="w-12 h-12 rounded-full bg-theme-orange/10 text-theme-orange flex items-center justify-center font-bold text-lg shrink-0">
                        ${item.pet_name ? item.pet_name[0] : '?'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <!-- ç¬¬ä¸€è¡Œï¼šåå­— + ä¸»äºº -->
                        <div class="flex items-center gap-2">
                            <h3 class="font-bold text-theme-brown text-lg truncate">${item.pet_name}</h3>
                            <span class="text-xs text-theme-sub truncate">(${item.owner_name})</span>
                        </div>
                        
                        <!-- ç¬¬äºŒè¡Œï¼šæ¨™ç±¤å€ -->
                        ${tagsHtml}
                        
                        <!-- ç¬¬ä¸‰è¡Œï¼šè³‡è¨Š -->
                        <div class="flex items-center gap-3 mt-2 text-xs text-theme-sub font-medium truncate">
                            <span class="flex items-center gap-1"><i data-lucide="scissors" class="w-3 h-3"></i> ${item.services ? item.services.join(', ') : 'æœªæŒ‡å®š'}</span>
                            <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${date}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right hidden sm:block pl-4 shrink-0">
                    <span class="text-xs font-bold text-theme-orange border border-theme-orange/30 px-3 py-1 rounded-full group-hover:bg-theme-orange group-hover:text-white transition-colors">
                        æŸ¥çœ‹
                    </span>
                </div>
            </div>`;
        }).join('');
        lucide.createIcons();
    }

    // æœå°‹åŠŸèƒ½
    document.getElementById('search-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = fullDataList.filter(item => 
            (item.owner_name && item.owner_name.includes(term)) ||
            (item.owner_phone && item.owner_phone.includes(term)) ||
            (item.pet_name && item.pet_name.includes(term))
        );
        renderDataList(filtered);
    });

    // é–‹å•Ÿè©³æƒ…å½ˆçª—
    function openModal(id) {
        currentItem = fullDataList.find(i => i.id == id);
        
        if (!currentItem) {
            alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©²ç­†è³‡æ–™");
            return;
        }

        const idStr = String(currentItem.id);
        document.getElementById('modal-id').innerText = `ID: #${idStr.length > 8 ? idStr.substring(0, 8) : idStr}`;
        
        const content = document.getElementById('modal-content');
        
        const sections = [
            {
                title: 'ğŸ‘¤ é£¼ä¸»è³‡æ–™',
                fields: [
                    { label: 'å§“å', key: 'owner_name' },
                    { label: 'é›»è©±', key: 'owner_phone' },
                    { label: 'Email', key: 'owner_email' },
                    { label: 'èº«åˆ†è­‰', key: 'owner_id' },
                    { label: 'åœ°å€', key: 'owner_address', full: true }
                ]
            },
            {
                title: 'ğŸš‘ ç·Šæ€¥è¯çµ¡',
                fields: [
                    { label: 'è¯çµ¡äºº', key: 'emergency_contact' },
                    { label: 'ç·Šæ€¥é›»è©±', key: 'emergency_phone' },
                    { label: 'æŒ‡å®šé†«é™¢', key: 'hospital', full: true }
                ]
            },
            {
                title: 'ğŸ¾ å¯µç‰©è³‡æ–™',
                fields: [
                    { label: 'åå­—', key: 'pet_name' },
                    { label: 'å“ç¨®', key: 'breed' },
                    { label: 'èŠ±è‰²', key: 'color' },
                    { label: 'å¹´é½¡', key: 'age', suffix: ' æ­²' },
                    { label: 'æ€§åˆ¥', key: 'sex' },
                    { label: 'çµç´®', key: 'neutered' },
                    { label: 'æ™¶ç‰‡', key: 'chip_number', full: true }
                ]
            },
            {
                title: 'âš ï¸ è¡Œç‚ºèˆ‡å¥åº·',
                fields: [
                    { label: 'è¦ªäºº', key: 'friendly_to_people' },
                    { label: 'è¦ªç‹—', key: 'friendly_to_dogs' },
                    { label: 'æ”»æ“Šæ€§', key: 'aggressive', highlight: 'æ˜¯' },
                    { label: 'ç—…å²', key: 'has_medical_history', highlight: 'æœ‰' },
                    { label: 'ç—…å²è©³æƒ…', key: 'medical_history', full: true }
                ]
            },
            {
                title: 'âœ‚ï¸ æœå‹™å…§å®¹',
                fields: [
                    { label: 'é …ç›®', key: 'services', full: true, isTag: true },
                    { label: 'æ¥å›æ™‚é–“', key: 'pickup_time' },
                    { label: 'é‡‘é¡', key: 'amount', suffix: ' å…ƒ' }
                ]
            }
        ];

        let html = '';

        // --- å‚™è¨»å€å¡Š ---
        const notes = currentItem.admin_notes || '';
        const noteDisplayClass = notes ? 'whitespace-pre-wrap text-theme-brown' : 'text-gray-400 italic';
        const noteDisplayText = notes ? notes : 'é»æ“Šä¸‹æ–¹ã€Œç·¨è¼¯è³‡æ–™ã€å³å¯æ–°å¢å‚™è¨»...';

        html += `
            <div class="glass-panel rounded-2xl p-5 border-l-4 border-l-theme-orange mb-6 shadow-sm">
                <h3 class="font-bold text-theme-brown text-sm mb-2 flex items-center gap-2">
                    <i data-lucide="notebook-pen" class="w-4 h-4 text-theme-orange"></i> ç®¡ç†å“¡å‚™è¨»
                </h3>
                <div class="view-mode text-sm min-h-[20px] leading-relaxed ${noteDisplayClass}">${noteDisplayText}</div>
                <textarea data-key="admin_notes" class="edit-mode hidden input-minimal w-full h-24 text-sm resize-none focus:ring-2 focus:ring-theme-orange/20" placeholder="è«‹è¼¸å…¥å‚™è¨»äº‹é …...">${notes}</textarea>
            </div>
        `;
        
        // --- å…¶ä»–è³‡æ–™å€å¡Š ---
        sections.forEach(section => {
            html += `
                <div class="glass-panel rounded-2xl overflow-hidden mb-4 border border-white/60">
                    <div class="bg-theme-orange/5 px-5 py-3 border-b border-theme-orange/10">
                        <h3 class="font-bold text-theme-brown text-sm">${section.title}</h3>
                    </div>
                    <div class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
            `;
            
            section.fields.forEach(f => {
                let val = currentItem[f.key];
                if (val === null || val === undefined) val = '-';
                if(f.suffix && val !== '-') val += f.suffix;
                
                const colSpan = f.full ? 'sm:col-span-2' : '';
                
                let displayVal = val;
                if (f.isTag && val !== '-' && Array.isArray(val)) {
                    displayVal = val.map(v => 
                        `<span class="inline-block px-2 py-0.5 rounded bg-theme-orange/10 text-theme-orange text-xs font-bold mr-1 mb-1">${v}</span>`
                    ).join('');
                } else if (f.highlight === true || val === f.highlight) {
                    displayVal = `<span class="text-theme-orange font-bold">${val}</span>`;
                }

                html += `
                    <div class="${colSpan}">
                        <label class="block text-[10px] font-bold text-theme-sub mb-1 uppercase tracking-wider">${f.label}</label>
                        <div class="view-mode text-sm font-bold text-theme-brown min-h-[24px] flex items-center">
                            ${displayVal}
                        </div>
                        <input type="text" data-key="${f.key}" value="${currentItem[f.key] || ''}" 
                            class="edit-mode hidden input-minimal py-1.5 px-3 text-sm h-9">
                    </div>
                `;
            });
            html += `</div></div>`;
        });

        if (currentItem.signature_data) {
            html += `
                <div class="glass-panel rounded-2xl p-5 border border-white/60 mt-4">
                    <h3 class="font-bold text-theme-brown text-sm mb-3">âœï¸ é›»å­ç°½å</h3>
                    <div class="bg-white/50 rounded-xl p-4 border border-dashed border-theme-brown/20 flex justify-center">
                        <img src="${currentItem.signature_data}" class="max-h-24 object-contain">
                    </div>
                </div>
            `;
        }

        content.innerHTML = html;
        lucide.createIcons();

        document.getElementById('btn-edit').classList.remove('hidden');
        document.getElementById('btn-save').classList.add('hidden');
        
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            panel.classList.remove('translate-y-full');
        }, 10);
    }

    // é—œé–‰è©³æƒ…å½ˆçª—
    function closeModal() {
        const modal = document.getElementById('detail-modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.add('opacity-0');
        panel.classList.add('translate-y-full');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
    function enableEdit() {
        document.getElementById('btn-edit').classList.add('hidden');
        document.getElementById('btn-save').classList.remove('hidden');
        
        document.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('hidden'));
        
        showToast('å·²é€²å…¥ç·¨è¼¯æ¨¡å¼', 'success');
    }

    // --- å®‰å…¨é©—è­‰é‚è¼¯ ---

    // é–‹å•Ÿé©—è­‰å½ˆçª—
    function showAuthModal(actionType) {
        pendingAction = actionType;
        
        const titleEl = document.getElementById('auth-title');
        const descEl = document.getElementById('auth-desc');
        
        if (actionType === 'save') {
            titleEl.innerText = 'å®‰å…¨é©—è­‰';
            descEl.innerText = 'ä¿®æ”¹è³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        } else if (actionType === 'delete') {
            titleEl.innerText = 'åˆªé™¤ç¢ºèª';
            descEl.innerText = 'åˆªé™¤æ­¤ç­†è³‡æ–™éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼';
        }

        document.getElementById('auth-password').value = '';
        
        const modal = document.getElementById('auth-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        
        setTimeout(() => document.getElementById('auth-password').focus(), 100);
    }

    // é—œé–‰é©—è­‰å½ˆçª—
    function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            pendingAction = null; 
        }, 300);
    }

    // è™•ç†é©—è­‰ç¢ºèª
    async function handleAuthConfirm() {
        const btn = document.getElementById('auth-confirm-btn');
        const originalText = btn.innerHTML;
        const password = document.getElementById('auth-password').value;
        
        if (!password) {
            showToast('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // é©—è­‰å¯†ç¢¼ (ä½¿ç”¨ç™»å…¥é‚è¼¯)
            const email = 'admin@hugbear.com'; // âš ï¸ å¿…é ˆèˆ‡ç™»å…¥æ™‚çš„ Email ä¸€è‡´
            const { error } = await _supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) throw error;

            const action = pendingAction;
            closeAuthModal();
            
            setTimeout(() => {
                if (action === 'save') executeSave();
                else if (action === 'delete') executeDelete();
            }, 300);

        } catch (error) {
            console.error(error);
            showToast('å¯†ç¢¼éŒ¯èª¤', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // é»æ“Šã€Œå„²å­˜è®Šæ›´ã€æŒ‰éˆ•
    function saveChanges() {
        let hasChanges = false;

        document.querySelectorAll('.edit-mode').forEach(input => {
            const key = input.dataset.key;
            if (!key) return;
            
            let originalValue = currentItem[key];
            if (originalValue === null || originalValue === undefined) originalValue = '';
            
            let newValue = input.value;
            
            if (String(originalValue).trim() !== String(newValue).trim()) {
                hasChanges = true;
            }
        });

        if (!hasChanges) {
            showToast('æœªåµæ¸¬åˆ°ä»»ä½•è®Šæ›´', 'info');
            openModal(currentItem.id);
            return;
        }

        // ä¿®æ”¹è³‡æ–™éœ€è¦é©—è­‰å¯†ç¢¼
        showAuthModal('save');
    }

    // é»æ“Šã€Œåˆªé™¤ã€æŒ‰éˆ•
    function requestDelete() {
        showAuthModal('delete');
    }

    // çœŸæ­£çš„å„²å­˜åŸ·è¡Œå‡½å¼
    async function executeSave() {
        const btn = document.getElementById('btn-save');
        if (!btn) return;
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> å„²å­˜ä¸­...';
            btn.disabled = true;
            lucide.createIcons();

            const updates = {};
            document.querySelectorAll('.edit-mode').forEach(input => {
                const key = input.dataset.key;
                if (key) updates[key] = input.value;
            });

            const { error } = await _supabase
                .from('contracts') // âš ï¸ ç¢ºèªè³‡æ–™è¡¨åç¨±
                .update(updates)
                .eq('id', currentItem.id);

            if (error) throw error;

            showToast('è³‡æ–™å·²æ›´æ–°', 'success');
            closeModal();
            loadData();

        } catch (error) {
            console.error('Save Error:', error);
            showToast('å„²å­˜å¤±æ•—: ' + error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // åŸ·è¡Œåˆªé™¤
    async function executeDelete() {
        const { error } = await _supabase
            .from('contracts') // âš ï¸ ç¢ºèªè³‡æ–™è¡¨åç¨±
            .delete()
            .eq('id', currentItem.id);

        if (error) {
            showToast('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
        } else {
            showToast('å·²åˆªé™¤è©²ç­†è³‡æ–™', 'success');
            closeModal();
            loadData();
        }
    }

    // Toast æç¤º
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        const bgClass = type === 'success' ? 'bg-[#10B981]' : (type === 'error' ? 'bg-red-500' : 'bg-[#3B82F6]');
        const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'alert-circle' : 'info');
        
        el.className = `toast ${type}`;
        el.innerHTML = `
            <div class="toast-icon ${bgClass} text-white rounded-full p-1 mr-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-${icon} w-3 h-3"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            </div>
            <div class="toast-message">${message}</div>
            <div class="toast-close">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        `;
        
        container.appendChild(el);
        lucide.createIcons();

        requestAnimationFrame(() => {
            el.classList.remove('translate-y-[-20px]', 'opacity-0');
        });

        setTimeout(() => {
            el.classList.add('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    }
    // --- è®Šæ›´å¯†ç¢¼åŠŸèƒ½ ---
    
    function openChangePasswordModal() {
        const modal = document.getElementById('change-pwd-modal');
        // æ¸…ç©ºæ¬„ä½
        document.getElementById('cp-old-password').value = '';
        document.getElementById('cp-new-password').value = '';
        document.getElementById('cp-confirm-password').value = '';
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        lucide.createIcons();
    }

    function closeChangePasswordModal() {
        const modal = document.getElementById('change-pwd-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function handleChangePassword() {
        const oldPwd = document.getElementById('cp-old-password').value;
        const newPwd = document.getElementById('cp-new-password').value;
        const confirmPwd = document.getElementById('cp-confirm-password').value;
        const btn = document.getElementById('btn-change-pwd');
        const originalText = btn.innerHTML;

        // 1. åŸºæœ¬é©—è­‰
        if (!oldPwd || !newPwd || !confirmPwd) {
            showToast('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
            return;
        }
        if (newPwd.length < 6) {
            showToast('æ–°å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ä½', 'error');
            return;
        }
        if (newPwd !== confirmPwd) {
            showToast('å…©æ¬¡æ–°å¯†ç¢¼è¼¸å…¥ä¸ä¸€è‡´', 'error');
            return;
        }

        try {
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> è™•ç†ä¸­';
            btn.disabled = true;
            lucide.createIcons();

            // 2. é©—è­‰èˆŠå¯†ç¢¼æ˜¯å¦æ­£ç¢º (é‡æ–°ç™»å…¥ä¸€æ¬¡ä¾†é©—è­‰)
            // é€™è£¡å‡è¨­ä½ çš„ç®¡ç†å“¡ email æ˜¯å›ºå®šçš„
            const email = 'hugbear0903@gmail.com'; 
            
            const { error: signInError } = await _supabase.auth.signInWithPassword({
                email: email,
                password: oldPwd
            });

            if (signInError) {
                throw new Error('èˆŠå¯†ç¢¼éŒ¯èª¤');
            }

            // 3. æ›´æ–°å¯†ç¢¼
            const { error: updateError } = await _supabase.auth.updateUser({ 
                password: newPwd 
            });

            if (updateError) throw updateError;

            // --- ä¿®æ”¹æˆåŠŸå¾Œçš„å‹•ä½œ ---
            await _supabase.auth.signOut(); // å¼·åˆ¶ç™»å‡º
            showToast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥', 'success');
            setTimeout(() => {
                location.reload(); // é‡æ–°æ•´ç†é é¢å›åˆ°ç™»å…¥ç•«é¢
            }, 1500);

        } catch (error) {

            console.error(error);
            showToast(error.message || 'ä¿®æ”¹å¤±æ•—', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
        }
    }

    // é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆçª—
    // --- PWA Service Worker è¨­å®š ---
const AppUtils = {
    // è¨»å†Š Service Worker
    registerServiceWorker: function() {
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw-admin.js');
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload();
                            }
                        });
                    });
                } catch (e) { 
                    console.error('SW Error:', e); 
                }
            });
        }
    }
};

// å•Ÿå‹• Service Worker
AppUtils.registerServiceWorker();
    document.getElementById('detail-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('detail-modal')) closeModal();
    });
</script>
</body>
</html>